<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload Payslip</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.1);
        }
        .form-group label {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">Upload Payslip</h2>
        <form action="{{ url_for('views.generate_payslip') }}" method="POST">
            <!-- Employee Dropdown -->
            <div class="form-group mb-3">
                <label for="employee">Select Employee</label>
                <select class="form-control" name="employee" id="employee" required>
                    <option value="" disabled selected>-- Select --</option>
                    {% for emp in employees %}
                        <option value="{{ emp.id }}">{{ emp.first_name }} ({{ emp.email }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Autofilled Fields -->
            <div class="form-group mb-3">
                <label for="name">Name</label>
                <input type="text" class="form-control" name="name" id="name" readonly>
            </div>
            <div class="form-group mb-3">
                <label for="designation">Designation</label>
                <input type="text" class="form-control" name="designation" id="designation" readonly>
            </div>
            <div class="form-group mb-3">
                <label for="doj">Date of Joining</label>
                <input type="date" class="form-control" name="doj" id="doj" readonly>
            </div>

            <!-- Month & Total Days -->
            <div class="form-group mb-3">
                <label for="month">Month</label>
                <input type="month" name="month" id="month" class="form-control" required>
            </div>
            <div class="form-group mb-3">
                <label for="total_days">Total Working Days</label>
                <input type="number" name="total_days" id="total_days" class="form-control" readonly>
            </div>

            <!-- Salary Components -->
            <div class="row">
                <div class="col-md-6 form-group mb-3"><label>Basic</label><input type="number" name="basic" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>HRA</label><input type="number" name="hra" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Conveyance</label><input type="number" name="conveyance" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Medi all</label><input type="number" name="medical" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Performance Bonus</label><input type="number" name="bonus" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Present Days</label><input type="number" name="present_days" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Earned Salary</label><input type="number" name="earned_salary" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Leave Deduction</label><input type="number" name="leave_deduction" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Advance Deduction</label><input type="number" name="advance_deduction" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Professional Tax</label><input type="number" name="pt" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Income Tax</label><input type="number" name="it" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Other Deduction</label><input type="number" name="other_deduction" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Arrears</label><input type="number" name="arrears" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Reimbursement</label><input type="number" name="reimbursement" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Loyalty Bonus</label><input type="number" name="loyalty_bonus" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>Net Pay</label><input type="number" name="net_pay" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>EPF</label><input type="number" name="epf" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>ESI</label><input type="number" name="esi" class="form-control"></div>
                <div class="col-md-6 form-group mb-3"><label>CTC</label><input type="number" name="ctc" class="form-control"></div>
            </div>

            <button type="submit" class="btn btn-primary mt-3">Upload Payslip</button>
        </form>
    </div>

    <!-- JavaScript -->
    <script>
        // Autofill Employee Info
        document.getElementById('employee').addEventListener('change', function () {
            const userId = this.value;
            if (!userId) return;

            const url = `/get_employee_details/${userId}`;
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        document.getElementById('name').value = data.name || '';
                        document.getElementById('designation').value = data.designation || '';
                        document.getElementById('doj').value = data.doj || '';
                    }
                })
                .catch(err => {
                    console.error('Error fetching employee details:', err);
                    alert('Failed to fetch employee data');
                });
        });

        // Calculate Working Days from Month
        document.getElementById('month').addEventListener('change', async function () {
            const monthValue = this.value;
            if (!monthValue) return;

            const [year, month] = monthValue.split('-').map(Number);
            const totalDaysInMonth = new Date(year, month, 0).getDate();

            let sundays = 0;
            let secondSaturday = null;
            let fourthSaturday = null;

            for (let day = 1; day <= totalDaysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0) sundays++;
                if (dayOfWeek === 6) {
                    const weekNum = Math.floor((day - 1) / 7) + 1;
                    if (weekNum === 2) secondSaturday = day;
                    if (weekNum === 4) fourthSaturday = day;
                }
            }

            let holidays = [];
            try {
                const res = await fetch(`/holidays/${year}/${month}`);
                if (res.ok) {
                    const data = await res.json();
                    holidays = data.holidays || [];
                }
            } catch (e) {
                console.warn("Could not load holidays for month.");
            }

            const leaveDays = sundays + (secondSaturday ? 1 : 0) + (fourthSaturday ? 1 : 0) + holidays.length;
            const workingDays = totalDaysInMonth - leaveDays;
            document.getElementById('total_days').value = workingDays;
        });
    </script>
</body>
</html>
